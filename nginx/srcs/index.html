<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="login-register">
        <form id="login-form" action="/login/" method="post">
            <input type="hidden" id="csrf_token" name="csrfmiddlewaretoken">
            <!-- <label for="username"> Username </label> -->
            <input type="text" id="username" name="username">
            <!-- <label for="password"> PassWord </label> -->
            <input type="password" id="password" name="password">
            <button type="submit">Login</button>
        </form>
        <div id="error" class="error_class">Invalid username or password</div>
        <form id="login42" action="/oauth/">
            <button type="submit">Log in with <b>intra 42</b></button>
            <div id="Invalid_creditienls" class="error_class"></div>
        </form>
        <button id="show-register">Register</button>
    </div>

    <div id="register-part">
        <h1>Register</h1>
        <form id="register-form" method="post">
            <input type="hidden" id="csrf_token" name="csrfmiddlewaretoken" value="">
            <label for="username">Username:</label>
            <input type="text" id="username" name="username" required>
            <div id="messageusername" class="error_class"></div>
            <br>
            <label for="firstname">firstname:</label>
            <input type="text" id="firstname" name="firstname" required>
            <div id="messagefirstname" class="error_class"></div>
            <br>
            <label for="lastname">lastname:</label>
            <input type="text" id="lastname" name="lastname" required>
            <div id="messagelastname" class="error_class"></div>
            <br>
            <br>
            <label for="fullname">fullname:</label>
            <input type="text" id="fullname" name="fullname" required>
            <div id="messagefullname" class="error_class"></div>
            <br>
            <label for="password1">Password:</label>
            <input type="password" id="password1" name="password1" required>
            <div id="messagepassword1" class="error_class"></div>
            <br>
            <label for="password2">Confirm Password:</label>
            <input type="password" id="password2" name="password2" required>
            <div id="messagepassword2" class="error_class"></div>
            <br>
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>
            <div id="messageemail" class="error_class"></div>
            <button type="submit">Register</button>
            <button type="button" id="show-login">Back to Login</button>
        </form>
        <div id="error_id" class="error_class"></div>
    </div>

   <!-- Update Profile Part -->
    <div id="UpdateProfile-Part" style="display:none;">
        <form id="update-form" method="put">
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            <label for="update-username">Username:</label>
            <input type="text" id="update-username" name="username" required>
            
            <label for="update-firstname">Firstname:</label>
            <input type="text" id="update-firstname" name="firstname" required>
            
            <label for="update-lastname">Lastname:</label>
            <input type="text" id="update-lastname" name="lastname" required>
            
            <label for="update-fullname">Fullname:</label>
            <input type="text" id="update-fullname" name="fullname" required>
            
            <label for="update-password1">Password:</label>
            <input type="password" id="update-password1" name="password1" required>
            
            <label for="update-confirm-password">Confirm Password:</label>
            <input type="password" id="update-confirm-password" name="password2" required>
            
            <label for="update-email">Email:</label>
            <input type="email" id="update-email" name="email" required>
            
            <button type="submit">Update Profile</button>
        </form>
    </div>

    <div id="profile">
        <h1>Welcome To Profile </h1>
        <h3>Username: <span id="user_name"></span></h3>
        <h3>Fullname: <span id="full_name"></span></h3>
        <!-- <button id="logout" >logout</button> -->
        <button id="back-to-home">Back to Home</button>
    </div>
 
    <div id="Home_Part">
        <h1> welcome To Home Page ^-^ </h1>
        <h3>Username: <span id="user-name"> </span></h3>
        <h3>Fullname: <span id="full-name"> </span></h3>
        <img id="profile-image" src="" alt="Profile Image" style="width:150px; height:auto;">
        <button id="logout" >logout</button>
        <button id="View_Profile" >View_Profile</button>
        <button id="show-UpdateProfile" >UpdateProfile</button>
    </div>

    <br>
    <br>
    <script src="script.js"></script>
    <script>
        // let csrfToken;
        document.addEventListener('DOMContentLoaded', function() {
            get_csrf_token();
            // Function to fetch and set the CSRF token
            function get_csrf_token() {
                fetch('/get_csrf_token/')
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('csrf_token').value = data.csrfToken;
                        csrfToken = data.csrfToken;
                    })
                    .catch(error => console.error('Error fetching CSRF token:', error));
            }

        // Handle the OAuth login button click
        document.getElementById('login42').addEventListener('click', function(event){
            event.preventDefault(); // Prevent the default form submission
            console.log('Login button clicked');
            console.log('send to backend for authorization code...');
            fetch('/oauth/', {
                method: 'GET',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            })
            .then(response => response.json()) // Parse the response as JSON
            .then(data => {

                // console.log('data = ', data)
                console.log('data =======> ', data.full_authoriztion_url)
                if (data.status == 'success') {
                    window.location.href = data.full_authoriztion_url;
                } else {
                    console.log('Error fetching authorization URL');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        // Handle the OAuth callback (after successful login)
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        console.log('URL Params:', urlParams.toString()); // Log the query string
        console.log('Authorization code:', code);
        console.log('window.location.search:', window.location.search);

        if (code) 
        {
            console.log('Authorization code detected, sending it to backend');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfToken) {
                console.log('CSRF token found:', csrfToken.value);
            }
            else {
                console.error('CSRF token not found!');
            }
            console.log('------- CSRF token found:', csrfToken.value);
            fetch('/oauth/callback/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    // 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-CSRFToken': document.getElementById('csrf_token').value,
                },
                body: JSON.stringify({ code: code })
            })
            .then(response => response.json())
            .then(data => {
                console.log('status ==> ', data.status )
                if (data.status == 'success') {
                    // Hide the login part and show the home part
                    document.getElementById('Home_Part').style.display = 'block';
                    document.getElementById('login-register').style.display = 'none';
                    document.getElementById('register-part').style.display = 'none';
                    document.getElementById('profile').style.display = 'none';
                    document.getElementById('user-name').textContent = data.data.username;
                    document.getElementById('full-name').textContent = data.data.fullname;
                    document.getElementById('profile-image').src = data.data.imageProfile
                    console.log('image = ', data.data.imageProfile)
                } else {
                    console.log('Error:', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    });
</script>
</body>
</html>


<!-- // Simple Terms
// Find the button: The script looks for the button with the ID login-button.
// Wait for a click: It sets up a listener to wait for the user to click the button.
// Stop the default action: When the button is clicked, the script prevents the form from submitting in the usual way.
// Redirect the user: Instead of submitting the form, the script redirects the user to the /oauth/authorize URL, starting the login process -->